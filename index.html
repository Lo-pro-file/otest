<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Video Player</title>
<style>
  :root{
    --bg1:#0f172a; --bg2:#111827; --card:#0b1220; --muted:#9ca3af;
    --accent:#2563eb; --success:#16a34a; --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    color:#e6eef8;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:36px;
  }
  .wrap{
    width:100%;
    max-width:900px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
    border-radius:14px;
    padding:22px;
    box-shadow:0 10px 30px rgba(2,6,23,0.6);
    border:1px solid rgba(255,255,255,0.03);
  }
  h1{margin:0 0 6px;font-size:20px}
  p.lead{margin:0 0 18px;color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .input{
    flex:1;
    display:flex;
    gap:8px;
  }
  input[type="text"]{
    flex:1;
    background:var(--card);
    border:1px solid rgba(255,255,255,0.03);
    padding:12px 14px;
    border-radius:8px;
    color: #e6eef8;
    outline:none;
    font-size:15px;
  }
  button.primary{
    background:var(--accent);
    color:white;
    border:none;
    padding:10px 14px;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
  }
  .meta{margin-top:18px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .video-wrap{
    margin-top:18px;
    display:flex;
    gap:14px;
    align-items:flex-start;
    flex-wrap:wrap;
  }
  .player{
    flex:1 1 540px;
    max-width:100%;
    background:var(--glass);
    border-radius:10px;
    padding:10px;
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  video{
    width:100%;
    border-radius:8px;
    background:#000;
  }
  .actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  .btn{
    padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600;
  }
  .btn.download{background:var(--success);color:#051213}
  .btn.copy{background:#7c3aed;color:white}
  .info{color:var(--muted);font-size:14px}
  .loading{margin-top:10px;color:var(--muted);font-size:14px}
  .error{margin-top:12px;color:#ff7b7b;background:rgba(255,123,123,0.06);padding:8px;border-radius:8px}
  @media (max-width:720px){ .row{flex-direction:column} .video-wrap{flex-direction:column} }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Smart Video Player</h1>
    <p class="lead">Paste page URL (your API will resolve the direct video link).</p>

    <div class="row">
      <div class="input">
        <input id="pageUrl" placeholder="Paste video page URL (e.g. https://linkdebhai.club/...)" />
        <button id="goBtn" class="primary">Get & Play</button>
      </div>
    </div>

    <div id="status" class="loading" aria-live="polite"></div>
    <div id="errorBox" class="error" style="display:none"></div>

    <div class="video-wrap" id="videoWrap" style="display:none">
      <div class="player">
        <div id="meta" style="width:100%;text-align:left">
          <div id="title" style="font-weight:700"></div>
          <div id="source" class="info"></div>
        </div>

        <div style="width:100%;margin-top:10px">
          <!-- HTML5 player -->
          <video id="player" controls preload="metadata" playsinline></video>
        </div>

        <div class="actions" id="actions">
          <a id="downloadBtn" class="btn download" href="#" download>‚¨áÔ∏è Download</a>
          <button id="copyBtn" class="btn copy">üìã Copy Link</button>
        </div>
        <div id="fileInfo" class="info"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const apiBase = "https://test-site-dl.woodmirror.workers.dev/?url=";
  const goBtn = document.getElementById("goBtn");
  const pageUrl = document.getElementById("pageUrl");
  const status = document.getElementById("status");
  const errorBox = document.getElementById("errorBox");
  const videoWrap = document.getElementById("videoWrap");
  const player = document.getElementById("player");
  const titleEl = document.getElementById("title");
  const sourceEl = document.getElementById("source");
  const downloadBtn = document.getElementById("downloadBtn");
  const copyBtn = document.getElementById("copyBtn");
  const fileInfo = document.getElementById("fileInfo");

  function showError(msg){
    errorBox.style.display = "block";
    errorBox.textContent = msg;
    status.textContent = "";
  }
  function clearError(){
    errorBox.style.display = "none";
    errorBox.textContent = "";
  }

  async function resolveAndPlay(pageLink) {
    clearError();
    videoWrap.style.display = "none";
    status.textContent = "‚è≥ Resolving direct link...";
    try {
      const res = await fetch(apiBase + encodeURIComponent(pageLink));
      // If API returns HTML (error page), throw
      const txt = await res.text();
      let data;
      try {
        data = JSON.parse(txt);
      } catch(e){
        throw new Error("API did not return JSON. Response starts with: " + txt.slice(0,120));
      }

      if (!data.success || !data.video){
        throw new Error("API returned no video info.");
      }
      const dl = data.video.downloadLink;
      if (!dl){
        throw new Error("No downloadLink found in API response.");
      }

      // Show meta
      titleEl.textContent = data.video.title || "Untitled";
      sourceEl.textContent = data.video.source || "";

      // prepare player
      // If it's HLS (.m3u8) ‚Äî use hls.js if supported
      const isHls = /\.m3u8(\?.*)?$/i.test(dl);
      if (isHls && window.Hls) {
        // use hls.js if available
        const hls = new Hls();
        hls.loadSource(dl);
        hls.attachMedia(player);
      } else if (isHls && player.canPlayType('application/vnd.apple.mpegurl')) {
        player.src = dl;
      } else {
        // set as normal src
        player.pause();
        player.removeAttribute("src");
        player.load();
        player.src = dl;
        // try to autoplay (user gesture may be required)
        try { await player.play(); } catch(_) {}
      }

      // Setup download & copy buttons
      downloadBtn.href = dl;
      downloadBtn.setAttribute("download", "");
      copyBtn.onclick = () => {
        navigator.clipboard.writeText(dl).then(()=> {
          copyBtn.textContent = "Copied ‚úÖ";
          setTimeout(()=> copyBtn.textContent = "üìã Copy Link", 1600);
        });
      };

      // file size hint (if present)
      fileInfo.textContent = data.video.fileSize ? ("Size: " + data.video.fileSize) : "";

      // show UI
      videoWrap.style.display = "flex";
      status.textContent = "";
    } catch (err) {
      showError("Error: " + (err.message || err));
      console.error(err);
    }
  }

  goBtn.addEventListener("click", () => {
    const url = pageUrl.value.trim();
    if (!url) { showError("Please paste a page URL."); return; }
    resolveAndPlay(url);
  });

  // allow Enter key
  pageUrl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") goBtn.click();
  });
})();
</script>

<!-- Optional: hls.js CDN loader (uncomment if you expect .m3u8) -->
<!-- <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script> -->

</body>
</html>
